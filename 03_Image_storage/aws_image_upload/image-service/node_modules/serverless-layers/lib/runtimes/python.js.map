{"version":3,"sources":["../../src/runtimes/python.js"],"names":["fs","require","path","PythonRuntime","parent","runtime","runtimeDir","plugin","libraryFolder","packageManager","packageManagerExtraArgs","dependenciesPath","compatibleRuntimes","compatibleArchitectures","copyBeforeInstall","packageExclude","commands","pip","settings","localpackageJson","join","process","cwd","localPackage","readFileSync","toString","e","log","exit","run","osVersion","match","runtimeVersion","version","isCompatible","startsWith","depsA","depsB","bucketService","downloadDependencesFile","remotePackage","isDifferent","isDiff","module","exports"],"mappings":";;;;;;;;;;;;;;AAAA,IAAMA,EAAE,GAAGC,OAAO,CAAC,IAAD,CAAlB;;AACA,IAAMC,IAAI,GAAGD,OAAO,CAAC,MAAD,CAApB;;IAEME,a;AACJ,yBAAYC,MAAZ,EAAoBC,OAApB,EAA6BC,UAA7B,EAAyC;AAAA;AACvC,SAAKF,MAAL,GAAcA,MAAd;AACA,SAAKG,MAAL,GAAcH,MAAM,CAACG,MAArB;AAEA,sBAAe;AACbF,MAAAA,OAAO,EAAPA,OADa;AAEbC,MAAAA,UAAU,EAAVA,UAFa;AAGbE,MAAAA,aAAa,EAAE,eAHF;AAIbC,MAAAA,cAAc,EAAG,KAJJ;AAKbC,MAAAA,uBAAuB,EAAE,EALZ;AAMbC,MAAAA,gBAAgB,EAAE,kBANL;AAObC,MAAAA,kBAAkB,EAAE,CAACP,OAAD,CAPP;AAQbQ,MAAAA,uBAAuB,EAAET,MAAM,CAACS,uBARnB;AASbC,MAAAA,iBAAiB,EAAE,EATN;AAUbC,MAAAA,cAAc,EAAE,CACd,cADc,EAEd,mBAFc,EAGd,iBAHc;AAVH,KAAf;AAiBA,SAAKC,QAAL,GAAgB;AACdC,MAAAA,GAAG,2BAAoB,gBAAaN,gBAAjC;AADW,KAAhB;AAGD;;;;WAED,gBAAO;AACL,UAAQA,gBAAR,GAA6B,KAAKJ,MAAL,CAAYW,QAAzC,CAAQP,gBAAR;AAEA,UAAMQ,gBAAgB,GAAGjB,IAAI,CAACkB,IAAL,CACvBC,OAAO,CAACC,GAAR,EADuB,EAEvBX,gBAFuB,CAAzB;;AAKA,UAAI;AACF,aAAKY,YAAL,GAAoBvB,EAAE,CAACwB,YAAH,CAAgBL,gBAAhB,EAAkCM,QAAlC,EAApB;AACD,OAFD,CAEE,OAAOC,CAAP,EAAU;AACV,aAAKnB,MAAL,CAAYoB,GAAZ,+BAAuCR,gBAAvC;AACAE,QAAAA,OAAO,CAACO,IAAR,CAAa,CAAb;AACD;AACF;;;;+GAED,iBAA0BvB,OAA1B;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBAC0B,KAAKD,MAAL,CAAYyB,GAAZ,CAAgB,kBAAhB,CAD1B;;AAAA;AACQC,gBAAAA,SADR;AAAA,iCAE2BzB,OAAO,CAAC0B,KAAR,CAAc,aAAd,CAF3B,wEAESC,cAFT;AAAA,iDAGS;AACLC,kBAAAA,OAAO,EAAEH,SADJ;AAELI,kBAAAA,YAAY,EAAEJ,SAAS,CAACK,UAAV,kBAA+BH,cAA/B;AAFT,iBAHT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;;;WASA,gBAAOI,KAAP,EAAcC,KAAd,EAAqB;AACnB,UAAI,CAACD,KAAL,EAAY;AACV,eAAO,IAAP;AACD;;AACD,aAAOA,KAAK,KAAKC,KAAjB;AACD;;;;kHAED;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBAC8B,KAAK9B,MAAL,CAAY+B,aAAZ,CAA0BC,uBAA1B,EAD9B;;AAAA;AACQC,gBAAAA,aADR;AAGMC,gBAAAA,WAHN,GAGoB,IAHpB;;AAAA,qBAKMD,aALN;AAAA;AAAA;AAAA;;AAMI,qBAAKjC,MAAL,CAAYoB,GAAZ,qBAA6B,gBAAahB,gBAA1C;AANJ;AAAA,uBAOwB,KAAK+B,MAAL,CAAYF,aAAZ,EAA2B,KAAKjB,YAAhC,CAPxB;;AAAA;AAOIkB,gBAAAA,WAPJ;;AAAA;AAAA,kDAUSA,WAVT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;;;;;AAcFE,MAAM,CAACC,OAAP,GAAiBzC,aAAjB","sourcesContent":["const fs = require('fs');\nconst path = require('path');\n\nclass PythonRuntime {\n  constructor(parent, runtime, runtimeDir) {\n    this.parent = parent;\n    this.plugin = parent.plugin;\n\n    this.default = {\n      runtime,\n      runtimeDir,\n      libraryFolder: 'site-packages',\n      packageManager:  'pip',\n      packageManagerExtraArgs: '',\n      dependenciesPath: 'requirements.txt',\n      compatibleRuntimes: [runtime],\n      compatibleArchitectures: parent.compatibleArchitectures,\n      copyBeforeInstall: [],\n      packageExclude: [\n        'package.json',\n        'package-lock.json',\n        'node_modules/**',\n      ]\n    };\n\n    this.commands = {\n      pip: `pip install -r ${this.default.dependenciesPath} -t .`,\n    };\n  }\n\n  init() {\n    const { dependenciesPath } = this.plugin.settings;\n\n    const localpackageJson = path.join(\n      process.cwd(),\n      dependenciesPath\n    );\n\n    try {\n      this.localPackage = fs.readFileSync(localpackageJson).toString();\n    } catch (e) {\n      this.plugin.log(`Error: Can not find ${localpackageJson}!`);\n      process.exit(1);\n    }\n  }\n\n  async isCompatibleVersion(runtime) {\n    const osVersion = await this.parent.run('python --version');\n    const [runtimeVersion] = runtime.match(/[0-9].[0-9]/);\n    return {\n      version: osVersion,\n      isCompatible: osVersion.startsWith(`Python ${runtimeVersion}`)\n    };\n  }\n\n  isDiff(depsA, depsB) {\n    if (!depsA) {\n      return true;\n    }\n    return depsA !== depsB;\n  }\n\n  async hasDependenciesChanges() {\n    const remotePackage = await this.plugin.bucketService.downloadDependencesFile();\n\n    let isDifferent = true;\n\n    if (remotePackage) {\n      this.plugin.log(`Comparing ${this.default.dependenciesPath} dependencies...`);\n      isDifferent = await this.isDiff(remotePackage, this.localPackage);\n    }\n\n    return isDifferent;\n  }\n}\n\nmodule.exports = PythonRuntime;\n"],"file":"python.js"}